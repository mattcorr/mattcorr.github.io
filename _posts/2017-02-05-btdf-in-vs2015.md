---
title:  "BTDF in Visual Studio 2015"
header:
  image: "/assets/images/2017/02/btdf-vs2015-header.jpg"
categories: 
  - BizTalk
tags:
  - powershell
  - biztalk
  - btdf
---
## Summary
The [BizTalk Deployment Framework](https://biztalkdeployment.codeplex.com/) tool (BTDF) is a very useful tool for packaging up BizTalk applications for deployment to an environment.
We have used it many times across various clients for all their BizTalk solutions and it works very well. (Especially for [Octopus Deploy](https://octopus.com) based automated deployments.)

Now with the release of [BizTalk 2016](https://msdn.microsoft.com/en-us/library/mt670742.aspx), the IDE is now Visual Studio 2015.

BTDF is currently not supported in Visual Studio 2015. **Yet.** 

**So when then?** Thomas is working away on an official update which should be here soon.
{: .notice--info}

## So what can we do in the meantime?
If you are like us and about to start on BizTalk 2016 development and need the BTDF to work NOW, then follow the steps below.

There are some useful comments on the [BTDF forums here](https://biztalkdeployment.codeplex.com/discussions/654830). We used this as a base.

## Pre-requisites
The following needs to be in place on your local developer VM first:

* Install [PowerShell 5.0](https://www.microsoft.com/en-us/download/details.aspx?id=50395)
* Install the GAC add on using `Install-Module Gac`. _(This is a very useful [add-on](https://github.com/LTruijens/powershell-gac) that make querying the GAC via PowerShell much easier than using [gacutil.exe](https://msdn.microsoft.com/en-us/library/ex0ss12c(v=vs.110).aspx).)_
* Download [version 5.6 of BTDF](https://biztalkdeployment.codeplex.com/downloads/get/1555083)
* Download this [workaround package](https://dl.dropboxusercontent.com/u/187700/BizTalk/BTDF-WorkAround.zip) and extract it locally on your dev VM somewhere

## Installation Process

Install the v5.6 of BTDF

Even though it is installed successfully, some DLLs are not "gac'ed" properly.

Use the PowerShell script below to fix this issue.

```powershell

param (
    [Parameter(Mandatory)]
    [ValidateScript({Test-Path -Path $_ -PathType Container})]
    [string] $BTDFInstallFolder,
    
    [Parameter(Mandatory)]
    [ValidateScript({Test-Path -Path $_ -PathType Container})]
    [string] $BTDFWorkaroundFolder
)

# Ensure the GAC Module is installed
$commands = Get-Command -Module GAC

if ($commands -eq $null)
{
    Write-Error "Unable to find the GAC Module. Need to install the GAC module first. " -ErrorAction Stop
}

Write-Host "Updating SSO Settings files..." -f Cyan
$installedDeployTools = Join-Path -Path $BTDFInstallFolder -ChildPath '\Framework\DeployTools\'
Copy-Item -Path "$BTDFWorkaroundFolder\SSO*.*" -Destination $installedDeployTools -Force

Write-Host "Adding the SSO Settings File Reader DLL to the GAC..." -f Cyan
Add-GacAssembly -Path "$BTDFWorkaroundFolder\SSOSettingsFileReader.dll" -Force

Write-Host "Updating to GACUtil 4.0 files..." -f Cyan
Copy-Item -Path "$BTDFWorkaroundFolder\GAC*.*" -Destination $installedDeployTools -Force

Write-Host "GACing the Log4net DLLs..." -f Cyan
Get-ChildItem -Path $installedDeployTools -Filter 'log4net*' | Foreach { Add-GacAssembly -Path $_.FullName -Force }

Write-Host "All done." -f Green

```

Run with two parameters.

1. **BTDFInstallFolder** - where BTDF was installed. Usually defaults to `C:\Program Files (x86)\Deployment Framework for BizTalk 5.6`
2. **BTDFWorkaroundFolder** - where the zip was extracted to

![](/assets/images/2017/02/2017-02-05_16-44-23.png)

## Visual Studio 2015 usage
While the MSI is installed, its not integrated into Visual Studio 2015. So we will have to "kludge" that for now.

To do this, create your BizTalk Solution in Visual Studio 2015.

Add a solution Folder to the root of the Solution

![](/assets/images/2017/02/2017-02-05_16-57-42.png)

Open the Package Manager Console inside of Visual Studio and run this PowerShell script.

**TIP:** You can get to the Package Manager Console by **Tools-> Nuget Package Manager -> Package Manager Console**
{: .notice--success}

```powershell
param (
    [Parameter(Mandatory)]
    [ValidateScript({Test-Path -Path $_ -PathType Container})] 
    [string] $BTDFTemplateFolder,

    [Parameter(Mandatory)]
    [string] $ParentSolutionFolder = "SolutionItems"
     )

# get the solution folder
$solution = Get-Interface $dte.Solution ([EnvDTE80.Solution2])
$solutionFolder = Get-ChildItem -Path $solution.Filename | Select-Object -ExpandProperty DirectoryName

# Copy the Deployment folder from BTDF to the Solution folder
$deploymentSourceFolder = Join-Path -Path $BTDFTemplateFolder -ChildPath '\Deployment'

if ((Test-Path -Path $deploymentSourceFolder) -eq $false)
{
    Write-Error "Unable to find the path $deploymentSourceFolder. Check the parameters and try again." -ErrorAction Stop
}
Write-Host "Copying BTDF Template to the Solution..."
Copy-Item -Path $deploymentSourceFolder -Destination $solutionFolder -Recurse

$targetDeploymentFolder = "$solutionFolder\Deployment"
Write-Host "Target Deployment Folder is: $targetDeploymentFolder"

Write-Host "Updating Deployment.btdfproj file for this solution..."
$solutionName = $solution.Properties | Where-Object Name -eq "Name" | Select-Object -ExpandProperty Value
$newGuid = New-Guid | Select-Object -ExpandProperty Guid
[xml] $configFile = Get-Content "$targetDeploymentFolder\Deployment.btdfproj"
# update the handful of fields that can be updated
$configFile.Project.PropertyGroup[0].ProjectName = "$solutionName"
$configFile.Project.PropertyGroup[1].ProductName = "$solutionName for BizTalk"
$configFile.Project.PropertyGroup[1].PackageComments = "$solutionName"
$configFile.Project.PropertyGroup[1].PackageDescription = "$solutionName"
$configFile.Project.PropertyGroup[1].ProductUpgradeCode  = "$newGuid"
$configFile.Save("$targetDeploymentFolder\Deployment.btdfproj")

# get the solution items folder
Write-Host "Creating Solution Folders and adding files..."
$solutionItemsProject =$solution.Projects | Where ProjectName -eq $ParentSolutionFolder
$solutionItemsInterface = Get-Interface $solutionItemsProject.Object ([EnvDTE80.SolutionFolder])

# add the deployment folder and its subfolder Environment Settings
$deploymentFolder = $solutionItemsInterface.AddSolutionFolder("Deployment")

$deploymentFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\BizTalk2016MSI.wxs") | Out-Null
$deploymentFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\Deployment.btdfproj") | Out-Null
$deploymentFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\InstallWizard.xml") | Out-Null
$deploymentFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\License.rtf") | Out-Null
$deploymentFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\PortBindingsMaster.xml") | Out-Null
$deploymentFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\UnInstallWizard.xml") | Out-Null

$deploymentInterface = Get-Interface $deploymentFolder.Object ([EnvDTE80.SolutionFolder])
$envSettingsFolder = $deploymentInterface.AddSolutionFolder("EnvironmentSettings")
$commandsFolder = $deploymentInterface.AddSolutionFolder("Commands")

$envSettingsFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\EnvironmentSettings\SettingsFileGenerator.xml") | Out-Null

$commandsFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\Bounce BizTalk.cmd") | Out-Null
$commandsFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\Build MSI.cmd") | Out-Null
$commandsFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\Deploy.cmd") | Out-Null
$commandsFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\Export Settings.cmd") | Out-Null
$commandsFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\Quick Deploy Orch.cmd") | Out-Null
$commandsFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\UnDeploy.cmd") | Out-Null
$commandsFolder.ProjectItems.AddFromFile("$targetDeploymentFolder\Update SSO.cmd") | Out-Null

#Save the solution
$solution.SaveAs($solution.FullName)
```
Use the following parameters

1. **BTDFTemplateFolder** - same as the parameter above
2. **ParentSolutionFolder** - name of the parent solution folder. I used "solutionItems". Your standard might be something else.


![](/assets/images/2017/02/2017-02-05_16-58-01.png)

This will copy files from the Workaround folder to your solution, add them to the Solution Folder.
The `Deployment.btdfproj` file is also updated with the name of the Solution and the GUIDS are generated.

**TIP:** If you prefer the Visual Studio structure to be different, feel free to edit the script above.
{: .notice--success}

![](/assets/images/2017/02/2017-02-05_16-58-08.png)

## How to use it?

The commands folder (highlighted in yellow above) work as a way to call the BTDF commands that would have appeared in the toolbar.

If you have an extension (like [Command Line](https://marketplace.visualstudio.com/items?itemName=MadsKristensen.OpenCommandLine)) that allows for executing of cmd files, you can right click and run the commands.

![](/assets/images/2017/02/2017-02-05_17-16-01.png)

The next step is to edit the `Deployment.btdfproj` file as per your usual process.

**NOTE:** This is still intended as a temporary fix until an official version of BTDF with Visual Studio 2015 support is released!
{: .notice--warning}

Shout out to [Paul Nichols](https://twitter.com/pauljnichols), a fellow Mexian who did some work on this as well :)

If there are any issues with this or you can think of some improvements, please let me know. 


